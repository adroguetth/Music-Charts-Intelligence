name: Download YouTube Chart

on:
  schedule:
    - cron: '0 12 * * 1'  # Cada lunes a las 12:00 UTC
  workflow_dispatch:  # EjecuciÃ³n manual
  push:
    branches:
      - main
    paths:
      - 'scripts/*.py'

env:
  RETENTION_DAYS: 30  # DÃ­as de retenciÃ³n

jobs:
  download-and-store:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
    
    steps:
    # 1. Checkout del repositorio
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. Configurar Python
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
    
    # 3. Instalar dependencias
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install -r requirements.txt
        python -m playwright install chromium
        python -m playwright install-deps
    
    # 4. Crear estructura de directorios
    - name: ğŸ“ Create directory structure
      run: |
        mkdir -p data charts_archive/databases charts_archive/backups charts_archive/raw_data
    
    # 5. Ejecutar script de descarga
    - name: ğŸš€ Run download script
      run: |
        python scripts/1_descargar.py
      env:
        GITHUB_ACTIONS: true
    
    # 6. Verificar resultados
    - name: âœ… Verify results
      run: |
        echo "ğŸ“Š Verificando resultados..."
        
        echo "ğŸ“ Contenido de charts_archive/:"
        ls -la charts_archive/
        
        echo -e "\nğŸ—ƒï¸  Base de datos:"
        ls -la charts_archive/databases/*.db 2>/dev/null || echo "No hay base de datos"
        
        echo -e "\nğŸ’¾ Backups:"
        ls -la charts_archive/backups/ 2>/dev/null || echo "No hay backups"
        
        echo -e "\nğŸ“„ Reportes:"
        ls -la charts_archive/*.txt 2>/dev/null || echo "No hay reportes"
    
    # 7. Commit y push de cambios
    - name: ğŸ“¤ Commit and push changes
      run: |
        echo "ğŸ”„ Preparando commit..."
        
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Agregar solo archivos de archivado
        git add charts_archive/
        
        if git diff --cached --quiet; then
          echo "ğŸ“­ No hay cambios para commit"
        else
          DATE=$(date +'%Y-%m-%d')
          WEEK=$(date +'%Y-W%W')
          git commit -m "ğŸ“Š YouTube Chart Update ${DATE} (Week ${WEEK}) [Automated]"
          
          echo "â¬†ï¸ Subiendo cambios..."
          git push origin HEAD:main
          echo "âœ… Cambios subidos al repositorio"
        fi
    
    # 8. Subir artifacts para debugging
    - name: ğŸ“¦ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: chart-data-${{ github.run_number }}
        path: |
          charts_archive/latest_chart.csv
          charts_archive/*.txt
          charts_archive/databases/*.db
        retention-days: 7
    
    # 9. Reporte final
    - name: ğŸ“ Final report
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“‹ REPORTE FINAL DE EJECUCIÃ“N"
        echo "========================================"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ”„ Trigger: ${{ github.event_name }}"
        echo ""
        
        if [ -f "charts_archive/databases/youtube_charts.db" ]; then
          echo "âœ… Base de datos actualizada exitosamente"
          DB_SIZE=$(stat -f%z "charts_archive/databases/youtube_charts.db" 2>/dev/null || stat -c%s "charts_archive/databases/youtube_charts.db")
          echo "ğŸ“Š TamaÃ±o de base de datos: $((DB_SIZE / 1024)) KB"
        else
          echo "âš ï¸  No se creÃ³ base de datos"
        fi
        
        echo ""
        echo "âœ… Proceso completado"
        echo "========================================"
