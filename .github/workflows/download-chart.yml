name: Download YouTube Chart (1+ Year Retention)

on:
  schedule:
    - cron: '0 12 * * 1'  # Cada lunes a las 12:00 UTC (8:00 AM Chile)
  workflow_dispatch:  # EjecuciÃ³n manual
  push:
    branches:
      - main
    paths:
      - 'scripts/1_descargar.py'  # Se ejecuta si cambia el script

env:
  RETENTION_YEARS: 1  # ConfiguraciÃ³n de retenciÃ³n
  SQLITE_ENABLED: true  # Habilitar base de datos SQLite

jobs:
  download-and-archive:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Tiempo suficiente para Playwright
    
    steps:
    # 1. Checkout del repositorio con todo el historial
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Trae todo el historial para commits
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # 2. Configurar Python
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
    
    # 3. Instalar dependencias
    - name: ğŸ“¦ Install Python dependencies
      run: |
        pip install -r requirements.txt
        echo "âœ… Dependencias Python instaladas"
    
    # 4. Instalar Playwright y Chromium
    - name: ğŸŒ Install Playwright browser
      run: |
        python -m playwright install chromium
        python -m playwright install-deps
        echo "âœ… Playwright y Chromium instalados"
    
    # 5. Crear directorios necesarios
    - name: ğŸ“ Create directories
      run: |
        mkdir -p data charts_archive
        echo "Directorios creados:"
        ls -la
        echo "ğŸ“ Estructura inicial preparada"
    
    # 6. Ejecutar script de descarga
    - name: ğŸš€ Run download script
      run: |
        echo "ğŸ”§ Iniciando descarga automÃ¡tica..."
        python scripts/1_descargar.py
      env:
        GITHUB_ACTIONS: true
    
    # 7. Verificar resultados
    - name: âœ… Verify downloaded files
      run: |
        echo "ğŸ“Š Verificando archivos descargados..."
        echo "ğŸ“ Contenido de data/:"
        ls -la data/ 2>/dev/null || echo "data/ estÃ¡ vacÃ­o"
        
        echo ""
        echo "ğŸ“ Contenido de charts_archive/:"
        ls -la charts_archive/ 2>/dev/null || echo "charts_archive/ estÃ¡ vacÃ­o"
        
        echo ""
        echo "ğŸ“ˆ Archivos CSV encontrados:"
        find . -name "*.csv" -type f | head -20 | while read file; do
          size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
          echo "  - $file (${size} bytes)"
        done
        
        # Verificar archivo latest
        if [ -f "charts_archive/latest_chart.csv" ]; then
          echo "âœ… latest_chart.csv encontrado y listo para anÃ¡lisis"
          echo "ğŸ“ LÃ­neas en latest_chart.csv: $(wc -l < charts_archive/latest_chart.csv)"
        else
          echo "âš ï¸  latest_chart.csv no encontrado"
        fi
    
    # 8. Limpiar archivos temporales (opcional)
    - name: ğŸ§¹ Clean temporary files
      if: always()
      run: |
        echo "Limpiando archivos temporales..."
        rm -rf data/debug_* 2>/dev/null || true
        echo "âœ… Limpieza completada"
    
    # 9. Commit y push de archivos archivados
    - name: ğŸ“¤ Commit and push archived files
      run: |
        echo "ğŸ”„ Preparando commit de archivos archivados..."
        
        # Configurar git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # Agregar solo los archivos de archivado
        git add charts_archive/
        
        # Verificar cambios
        if git diff --cached --quiet; then
          echo "ğŸ“­ No hay cambios en charts_archive para commit"
        else
          # Hacer commit
          DATE=$(date +'%Y-%m-%d')
          git commit -m "ğŸ“Š YouTube Chart Update ${DATE} [Automated]"
          
          # Hacer push
          echo "â¬†ï¸ Subiendo cambios al repositorio..."
          git push origin main
          echo "âœ… Archivos archivados subidos al repositorio"
          
          # Resumen
          echo ""
          echo "ğŸ“ˆ RESUMEN DEL COMMIT:"
          git show --stat --name-only HEAD | tail -20
        fi
    
    # 10. Crear backup mensual (primer lunes del mes)
    - name: ğŸ—“ï¸ Create monthly backup
      if: github.event.schedule == '0 12 * * 1'  # Solo en automÃ¡tico
      run: |
        # Verificar si es el primer lunes del mes
        DAY=$(date +%d)
        if [ "$DAY" -le 7 ]; then
          echo "ğŸ“… Es el primer lunes del mes, creando backup mensual..."
          
          # Crear backup de todo el mes anterior
          LAST_MONTH=$(date -d 'last month' +'%Y-%m')
          BACKUP_FILE="charts_archive/backup_${LAST_MONTH}.tar.gz"
          
          # Comprimir todos los CSVs del mes anterior
          find charts_archive -name "youtube_chart_${LAST_MONTH}-*.csv" -type f | tar -czf "$BACKUP_FILE" -T -
          
          if [ -f "$BACKUP_FILE" ]; then
            echo "âœ… Backup mensual creado: $BACKUP_FILE"
            ls -lh "$BACKUP_FILE"
          else
            echo "âš ï¸ No se pudo crear backup mensual"
          fi
        else
          echo "ğŸ“… No es el primer lunes del mes, omitiendo backup mensual"
        fi
    
    # 11. Subir artifacts para inspecciÃ³n
    - name: ğŸ“¦ Upload artifacts for inspection
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: chart-download-results
        path: |
          charts_archive/latest_chart.csv
          data/*.csv
          charts_archive/*.db
        retention-days: 7  # Temporal para debugging
        compression-level: 1
    
    # 12. Reporte final
    - name: ğŸ“ Final report
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“‹ REPORTE FINAL DE EJECUCIÃ“N"
        echo "========================================"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ”„ Trigger: ${{ github.event_name }}"
        echo "ğŸ·ï¸  RetenciÃ³n configurada: ${{ env.RETENTION_YEARS }} aÃ±o(s)"
        echo ""
        echo "ğŸ“ Archivos en charts_archive/:"
        ls -1 charts_archive/ | head -10
        echo ""
        echo "ğŸ“Š Total de archivos CSV histÃ³ricos:"
        find charts_archive -name "youtube_chart_*.csv" | wc -l
        echo ""
        echo "âœ… Proceso completado"
        echo "========================================"
